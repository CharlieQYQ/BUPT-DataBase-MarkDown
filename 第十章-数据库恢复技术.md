# 第十章·数据库恢复技术
> 乔毅
> 2019210472
> 第十章、第十一章讨论**事务处理**（transaction processing）技术
> 事务是一系列的数据库操作

[TOC]

## 10.1 事务的基本概念
在讨论数据库恢复技术之前先讲解事务的基本概念和事务的性质
- 1.事务
	- **事务**是用户定义的一个数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位
	- 事务和程序是两个概念，一般一个程序包含多个事务
	- 定义事务的SQL语句一般有三条
		- `BEGIN TRANSACTION`	开始事务
		- `COMMIT`	提交事务的所有操作
		- `ROLLBACK`	回滚，撤销事务中已完成的所有操作，回到事务开始时的状态
- 2.事务的ACID特性
	- 原子性（Atomicity）
		- 事务是数据库的逻辑工作单位
		- 事务中的诸操作要么都做，要么都不做
	- 一致性（Consistency）
		- 事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态
		- 当数据库只包含成功事务提交的结果时，就说数据库处于一致性状态
		- 一致性和原子性是密切相关的
	- 隔离性（Isolation）
		- 一个事务的执行不能被其他事务干扰
		- 并发执行的各个事务之间不能相互干扰
	- 持续性（Durability）
		- 持续性也成**永久性**（Permanence）
		- 一个事务一旦提交，它对数据库中数据的改变就应该是永久性的
		- 接下来的其他操作或故障不应该对其执行结果有任何影响

**事务是恢复和并发控制的基本单位**  

## 10.2 数据库恢复概述
- 计算机系统中，下列事件是不可避免的
	- 硬件的故障
	- 软件的错误
	- 操作员的失误
	- 恶意的破坏
- 数据库管理系统必须具有把数据库从错误状态恢复到某一已知的正确状态的功能

## 10.3 故障的种类
- 1.事务内部的故障
	- 事务内部的故障有的是可以通过事务程序本身发现的
	- 有的是非预期的，不能由事务程序处理
	- 事务内部更多的故障是非预期的，是不能由应用程序处理的
	- 事务故障仅指上述非预期的故障
	- 恢复程序要在不影响其他事务运行的情况下，强行回滚该事物，即撤销该事物已经做出的任何对数据库的修改，使得该事物好像根本没有启动一样。这类恢复操作称为**事务撤销**（UNDO）
- 2.系统故障
	- 系统故障是指造成系统停止的运转的任何事件，使得系统要重新启动
		- 特定类型的硬件错误（CPU故障）
		- 操作系统故障
		- DBMS代码错误
		- 系统断电
	- 回复子系统必须在系统重新启动时让所有非正常终止的事务回滚，强行撤销所有未完成的事务
	- 系统重新启动后，恢复子系统除需要撤销所有未完成的事务外，还需要**重做**（REDO）所有已提交的事务，以将数据库真正恢复到一致状态
- 3.介质故障
	- 系统故障常称为**软故障**（soft crash），介质故障称为**硬故障**（hard crash）
	- 硬故障指外存故障，如磁盘损坏、磁头碰撞、瞬时强磁场干扰等
- 4.计算机病毒
	- 计算机病毒是一种人为的故障或损坏，是一种计算机程序
- 总结
	- 一是数据库本身被破坏
	- 二是数据库没有被破坏，但数据可能不正确
- 恢复的原理——**冗余**

## 10.4 恢复的实现技术
建立冗余数据最常用的技术是**数据转储**和**登记日志文件**（logging）  
通常在一个数据库系统中两种方法一起采用  

### 10.4.1 数据转储
- 数据转储是数据库恢复中采用的基本技术
	- 定期的将整个数据库复制到磁盘或其他介质上保存起来的过程
	- 这些备用的数据称为**后备副本**（backup）或后援副本
- 当数据库遭到破坏后可以将后备副本重新装入，但重装后备副本只能将数据库恢复到转储时的状态
- 转储可分为静态转储和动态转储
	- **静态转储**是在系统中无运行事务时进行的转储操作
		- 转储开始时数据库处于一致性状态
		- 转储期间不允许对数据库进行任何存取、修改活动 [降低数据库的可用性]
		- 即静态转储得到的一定是一个数据一致性额副本
	- **动态转储**是指转储期间允许对数据库进行存取或修改
		- 转储和用户事务可以并发执行
		- 转储结束时后备副本上的数据并不能保证正确有效
		- 必须把转储期间各事务对数据库的活动登记下来，建立日志文件（log file）
- 还可分为**海量转储**和**增量转储**
	- 海量转储是指每次转储全部数据库
	- 增量转储是指每次只转储上一次转储后更新过的数据
- 综合上述两条，共有四种数据转储方式
	- 动态海量转储
	- 动态增量转储
	- 静态海量转储
	- 静态增量转储

### 10.4.2 登记日志文件
- 1.日志文件的格式和内容
	- 日志文件是用来记录事务对数据库的更新操作的文件
	- 两种格式
		- 以记录为单位的日志文件
		- 以数据块为单位的日志文件
	- 以记录为单位的日志文件包括
		- 各个事物的开始	`BEGIN TRANSACTION`
		- 各个事务的结束	`COMMIT或ROLLBACK`
		- 各个事务的所有更新操作
		- [以上均为日志文件的一个日志记录（log record），包括]
			- 事务标识
			- 操作的类型（插入、删除或修改）
			- 操作对象
			- 更新前数据的旧值
			- 更新后数据的新值
- 2.日志文件的作用
	- 事务故障恢复和系统故障恢复必须用日志文件
	- 在动态转储中必须建立日志文件
	- 在静态转储中也可以建立日志文件
- 3.登记日志文件
为保证数据库是可恢复的，登记日志文件时必须遵守两条准则
	- 等级的次序严格按照并发事务执行的时间次序
	- 必须先写日志文件，后写数据库

## 10.5 恢复策略

### 10.5.1 事务故障的恢复
事务故障是指事务在运行至正常终止点前被终止  
这时恢复子系统应利用日志文件撤销（UNDO）此事务已对数据库进行的修改  
事务故障的恢复是由系统自动完成的，对用户是透明的  

### 10.5.2 系统故障的恢复
系统故障导致数据库不一致状态的原因有两个
	- 一是未完成事务对数据库的更新已写入数据库
	- 二是已提交事务对数据库的更新可能还留在缓存区没来得及写入数据库
因此恢复操作就是要撤销故障发生时未完成的事务，重做已完成的事务  
系统故障的恢复是由系统在重新启动时自动完成的，不需要用户干预  

### 10.5.3 介质故障的恢复
发生介质故障后，磁盘上的物理数据和日志文件被破坏，这是最严重的一种故障  
恢复的方法是**重装数据库，然后重做已完成的事务**  
	- 装入最新的数据库后备副本
	- 装入相应的日志文件副本
介质故障的恢复需要数据库管理员（DBA）的介入，但DBA只需要重装最近转储的数据库副本和日志文件副本，然后执行系统的恢复命令即可  

## 10.6 具有检查点的恢复技术
这种技术在日志文件中增加一类新的记录——**检查点**（checkpoint）记录，增加一个重新开始文件，并让恢复子系统在登陆日志文件期间动态的维护日志  
检查点记录的内容包括：  
	- 建立检查点时刻所有正在执行的事务清单
	- 这些事务最近一个日志记录的地址
动态维护日志文件的方法是，周期性的执行建立检查点、保存数据库状态的操作  
使用检查点可以改善恢复效率  

## 10.7 数据库镜像
为避免磁盘介质出现故障影响数据库的可用性，许多数据库管理系统提供了镜像（mirror）功能用于数据库恢复  
即根据DBA的要求，自动把整个数据库或其中的关键数据复制到另一个磁盘上  
每当主数据库更新时，DBMS自动把更新后的数据复制过去，由DBMS自动保证镜像数据与主数据库的一致性  
在实际应用中，用户往往只选择对关键数据和日志文件进行镜像，而不是对整个数据库进行镜像  

## 10.8 小结
**保证数据一致性是对数据库的最基本的要求**  
事务是数据库的逻辑工作单位  
数据库能保证事务的ACID特性，也就保证数据库处于一致状态  
事务不仅是恢复的基本单位，也是并发控制的基本单位  

## 10.9 Log
- 2021.5.29 编写完毕并上传[Github](https://github.com/CharlieQYQ/BUPT-DataBase-MarkDown)
